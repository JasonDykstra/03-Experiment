<!DOCTYPE html>
<html>
<head>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <title>03-Experiment-JasonDykstra-ColbyFrechette.html</title>
</head>
<body>
<script>
    console.log(d3); // test if d3 is loaded

    //window.onload=drawBarChart();
    window.onload = startPage();

    const csvRows = [["Type", "Smaller", "Larger", "Actual Ratio", "Guess Ratio"]];

    var tempData;

    var numSubmits = 0;
    var maxSubmits = 60;

    // SVG dimensions
    var SVGWidth = 500;
    var SVGHeight = 600;
    //var margins = window.innerWidth/10;

    var svgdiv = document.createElement("div");
    svgdiv.classList.add("svgdiv");
    // Hide the svg div initially so that it doesn't make the start screen take up twice the view height
    svgdiv.style.display = 'none';
    document.body.appendChild(svgdiv);
    svgdiv.id = "svgdiv";
    var svg = d3.select("#svgdiv")
        .append("svg")
        .attr("width", SVGWidth)
        .attr("height", SVGHeight);


    const randArray = [];
    var randArrayLength = maxSubmits;

    console.log("rand array length: " + randArrayLength);

    for (var i = 0; i < randArrayLength; i++) {
        if (i < randArrayLength / 3) {
            randArray[i] = 0;
        } else if (i < ((randArrayLength / 3) * 2)) {
            randArray[i] = 1;
        } else {
            randArray[i] = 2;
        }
    }


    console.log("rand array: " + randArray);

    function shuffleArray(array) {
        let curId = array.length;
        // There remain elements to shuffle
        while (0 !== curId) {
            // Pick a remaining element
            let randId = Math.floor(Math.random() * curId);
            curId -= 1;
            // Swap it with the current element.
            let tmp = array[curId];
            array[curId] = array[randId];
            array[randId] = tmp;
        }
        return array;
    }

    shuffleArray(randArray);

    console.log("Suffled array: " + randArray);

    function startPage() {

        var startbuttonDiv = document.createElement("div");
        var pDiv = document.createElement("div");
        var startDiv = document.createElement("div");


        startbuttonDiv.style.height = "200px";
        pDiv.style.height = "100px";
        //startDiv.style.height = "200px";
        startDiv.id = "startDiv";
        pDiv.id = "pDiv";
        startbuttonDiv.id = "startbuttonDiv";
        startDiv.appendChild(pDiv);
        startDiv.appendChild(startbuttonDiv);
        document.body.appendChild(startDiv);

        var intro = document.createElement("P");
        intro.innerHTML = "In this experiment,<br> you are asked to judge<br> what is the percent of a smaller value to a larger value in several charts. <br> <br> We won't record any other information from you except your answers. <br> Click the \"agree\" button to begin";
        pDiv.appendChild(intro);


        var start = document.createElement("BUTTON");
        var startText = document.createTextNode("Start");
        start.appendChild(startText);
        startbuttonDiv.appendChild(start);
        start.classList.add('StartButton')
        start.classList.add('StartPage')
        start.onclick = function () {
            startDiv.style.display = "none";
            // Un-hide the svg div
            svgdiv.style.display = 'block';
            textBoxSubmit();
            drawNextChart(randArray[numSubmits]);
        }

    }

    function downloadCSV() {
        // Building the CSV from the Data two-dimensional array
        // Each column is separated by ";" and new line "\n" for next row
        var csvContent = '';
        csvRows.forEach(function (infoArray, index) {
            dataString = infoArray.join(';');
            csvContent += index < csvRows.length ? dataString + '\n' : dataString;
        });

        // The download function takes a CSV string, the filename and mimeType as parameters
        // Scroll/look down at the bottom of this snippet to see how download is called
        var download = function (content, fileName, mimeType) {
            var a = document.createElement('a');
            mimeType = mimeType || 'application/octet-stream';

            if (navigator.msSaveBlob) { // IE10
                navigator.msSaveBlob(new Blob([content], {
                    type: mimeType
                }), fileName);
            } else if (URL && 'download' in a) { //html5 A[download]
                a.href = URL.createObjectURL(new Blob([content], {
                    type: mimeType
                }));
                a.setAttribute('download', fileName);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                location.href = 'data:application/octet-stream,' + encodeURIComponent(content); // only this mime type is supported
            }
        }

        download(csvContent, 'dowload.csv', 'text/csv;encoding:utf-8');
    }

    function textBoxSubmit() {
        var div = document.createElement("div");

        div.style.height = "100px";

        document.body.appendChild(div);

        // Text box
        var textInput = document.createElement("INPUT");
        textInput.setAttribute("placeholder", "Enter Percent E.g. 50");
        textInput.setAttribute("type", "text");
        div.appendChild(textInput);
        var percentIcon = document.createElement("Percent");
        var percentIconText = document.createTextNode("%");
        percentIcon.id = "percentIcon";
        percentIcon.style.fontFamily = "arial";
        percentIcon.appendChild(percentIconText);
        div.appendChild(percentIcon);

        // Submit button
        var submit = document.createElement("Button");
        var submitText = document.createTextNode("Submit");

        submit.appendChild(submitText);
        div.appendChild(submit);
        submit.onclick = function () {
            if (textInput.value <= 100 && textInput.value > 0 && textInput.value != '') {
                numSubmits++;
                var text = textInput.value;
                textInput.value = '';
                text = text / 100;
                console.log(text);
                //userInput = text;

                // Update the csv
                tempData.push(text);
                csvRows.push(tempData);


                console.log(csvRows);
                if (numSubmits < maxSubmits) {
                    drawNextChart(randArray[numSubmits]);
                } else downloadCSV();

            } else {
                alert("Please type a number between 0 and 100 (Inclusive for 100)");
            }

        }
    }

    function drawNextChart(num) {
        if (num == 0) {
            drawBarChart();
        } else if (num == 1) {
            drawPieChart();
        } else if (num == 2) {
            drawStackedChart();
        }
    }


    function drawBarChart() {

        // Clear svg
        d3.selectAll("svg > *").remove();

        var barWidth = 50;
        var barPadding = 5;

        // Random Dataset Method 2 (JavaScript Random Number Generation)
        var data2 = [];
        var numDataPoints = 0;
        var maxDataPoints = 8;
        while (numDataPoints < maxDataPoints) {
            var newNumber = Math.random();
            if (newNumber > 0.1) {
                data2.push(newNumber);
                numDataPoints++;
            }
        }

        var twoDots = [];
        while (twoDots.length < 2) {
            var dotIndex = Math.floor(Math.random() * maxDataPoints);
            if (twoDots.length == 1 && twoDots[0] != dotIndex) {
                twoDots[1] = dotIndex;
            } else if (twoDots.length == 0) {
                twoDots[0] = dotIndex;
            }
        }

        console.log("Two dots: " + twoDots);

        console.log(data2);

        // Bar Chart
        svg.selectAll("bar")
            .data(data2)
            .enter()
            .append("rect")
            .attr('class', 'bar')
            .style('height', function (d) {
                return d * 500 + 'px';
            })
            .style('width', barWidth - barPadding)
            .attr("y", function (d) {
                return SVGHeight - d * 500 - barPadding;
            })

            .attr("transform", function (d, i) {
                var translate = [barPadding + barWidth * i, 0];
                return "translate(" + translate + ")";
            })
            .style("stroke", "black")
            .style("stroke-width", 3)
            .style("fill", "none")
        ;

        svg.append('circle')
            .attr("cx", (twoDots[0] * (barWidth)) + barWidth / 2 + barPadding / 2)
            .attr("cy", SVGHeight - 15)
            .attr("r", 10)
            .style("fill", "black");
        svg.append('circle')
            .attr("cx", (twoDots[1] * (barWidth)) + barWidth / 2 + barPadding / 2)
            .attr("cy", SVGHeight - 15)
            .attr("r", 10)
            .style("fill", "black");

        var smallerBarHeight = Math.min(data2[twoDots[0]], data2[twoDots[1]]);

        var largerBarHeight = Math.max(data2[twoDots[0]], data2[twoDots[1]]);

        // Shrink bar heights to 4 decimal places
        smallerBarHeight = Math.round(smallerBarHeight * 100000) / 100000;
        largerBarHeight = Math.round(largerBarHeight * 100000) / 100000;

        var ratio = Math.round((smallerBarHeight / largerBarHeight) * 100000) / 100000;

        console.log("Large dot: " + largerBarHeight);
        console.log("Smaller dot: " + smallerBarHeight);
        console.log("Ratio: " + ratio);


        tempData = ["Bar", smallerBarHeight, largerBarHeight, ratio];


    }

    function drawPieChart() {

        d3.selectAll("svg > *").remove();


        // Random Dataset Method 2 (JavaScript Random Number Generation)
        var data = [];
        var numDataPoints = 0;
        var maxDataPoints = 9;
        while (numDataPoints < maxDataPoints) {
            var newNumber = Math.random();
            if (newNumber > 0.1) {
                data.push(newNumber);
                numDataPoints++;
            }
        }

        var width = 360;
        var height = 360;
        var radius = Math.min(width, height) / 3;

        var pie = d3.pie()
            .value(function (d) {
                return d.value;
            })
            .sort(null);
        var data_ready = pie(d3.entries(data));

        console.log(data_ready);

        var arcGenerator = d3.arc()
            .innerRadius(0)
            .outerRadius(radius)

        svg
            .selectAll('pie')
            .data(data_ready)
            .enter()
            .append('path')
            .attr('d', arcGenerator
            )
            .attr("transform", "translate(" + SVGWidth / 2 + "," + SVGHeight / 2 + ")")
            .attr('fill', 'white')
            .attr("stroke", "black")
            .style("stroke-width", "2px")
            .style("opacity", 0.7)


        var twoDots = [];
        while (twoDots.length < 2) {
            var dotIndex = Math.floor(Math.random() * maxDataPoints);
            if (twoDots.length == 1 && twoDots[0] != dotIndex) {
                twoDots[1] = dotIndex;
            } else if (twoDots.length == 0) {
                twoDots[0] = dotIndex;
            }
        }

        /*
        x = cx + r * cos(a)
        y = cy + r * sin(a)
        */

        // Add pi/2 to the angles since a unit circle starts at East while the pie chart start drawing at North
        var dot0startAngle = data_ready[twoDots[0]].startAngle + Math.PI / 2;
        var dot0endAngle = data_ready[twoDots[0]].endAngle + Math.PI / 2;
        var dot1startAngle = data_ready[twoDots[1]].startAngle + Math.PI / 2;
        var dot1endAngle = data_ready[twoDots[1]].endAngle + Math.PI / 2;

        var dot0x = -((radius + 20) * (Math.cos(dot0endAngle - (dot0endAngle - dot0startAngle) / 2)));
        var dot0y = -((radius + 20) * (Math.sin(dot0endAngle - (dot0endAngle - dot0startAngle) / 2)));
        var dot1x = -((radius + 20) * (Math.cos(dot1endAngle - (dot1endAngle - dot1startAngle) / 2)));
        var dot1y = -((radius + 20) * (Math.sin(dot1endAngle - (dot1endAngle - dot1startAngle) / 2)));

        console.log("cos: " + Math.cos(dot0endAngle));
        console.log("sin: " + Math.sin(dot0endAngle));

        // ADD circles to pie slices
        svg.append("circle")
            .attr("r", 5)
            .attr("cx", dot0x)
            .attr("cy", dot0y)
            .attr("transform", "translate(" + SVGWidth / 2 + "," + SVGHeight / 2 + ")")
            .attr('fill', 'black')
            .attr("stroke", "black")
            .style("stroke-width", "2px");

        svg.append("circle")
            .attr("r", 5)
            .attr("cx", dot1x)
            .attr("cy", dot1y)
            .attr("transform", "translate(" + SVGWidth / 2 + "," + SVGHeight / 2 + ")")
            .attr('fill', 'black')
            .attr("stroke", "black")
            .style("stroke-width", "2px");


        var dot0angle = dot0endAngle - dot0startAngle;
        var dot1angle = dot1endAngle - dot1startAngle;

        var dot0area = Math.pow(radius, 2) * (dot0angle / 2);
        var dot1area = Math.pow(radius, 2) * (dot1angle / 2);

        var smallArea = Math.min(dot0area, dot1area);
        var largeArea = Math.max(dot0area, dot1area);

        var ratio = Math.round((smallArea / largeArea) * 100000) / 100000;

        tempData = ["Pie", smallArea, largeArea, ratio];


    }

    function drawStackedChart() {
        d3.selectAll("svg > *").remove();

        var data = [];
        var numDataPoints = 0;
        var maxDataPoints = 9;
        while (numDataPoints < maxDataPoints) {
            var newNumber = Math.random();
            if (newNumber > 0.1) {
                data.push(newNumber);
                numDataPoints++;
            }
        }

        var prev_width = [0,
            data[0],
            data[0] + data[1],
            data[0] + data[1] + data[2],
            data[0] + data[1] + data[2] + data[3],
            data[0] + data[1] + data[2] + data[3] + data[4],
            data[0] + data[1] + data[2] + data[3] + data[4] + data[5],
            data[0] + data[1] + data[2] + data[3] + data[4] + data[5] + data[6],
            data[0] + data[1] + data[2] + data[3] + data[4] + data[5] + data[6] + data[7]
        ];

        var barWidth = 60;
        var padding = 5;
        var barx = SVGWidth / 2 - barWidth / 2

        svg.selectAll('rect')
            .data(data)
            .enter()
            .append('rect')
            .attr('width', barWidth)
            .attr('x', barx)
            .attr('fill', 'white')
            .style('stroke', 'black')
            .style('stroke-width', 3)
            .attr('y', function (d, i) {
                return prev_width[i] * 75 + padding;
            })
            .attr('height', function (d) {
                return d * 75;
            });


        var twoDots = [];
        while (twoDots.length < 2) {
            var dotIndex = Math.floor(Math.random() * maxDataPoints);
            if (twoDots.length == 1 && twoDots[0] != dotIndex) {
                twoDots[1] = dotIndex;
            } else if (twoDots.length == 0) {
                twoDots[0] = dotIndex;
            }
        }


        bar0cell = prev_width[twoDots[0]] * 75 + padding;
        bar0nextCell = prev_width[twoDots[0] + 1] * 75 + padding;
        bar0y = bar0nextCell - (bar0nextCell - bar0cell) / 2;

        bar1cell = prev_width[twoDots[1]] * 75 + padding;
        var bar1nextCell;


        if (twoDots[1] == 8) {
            bar1nextCell = bar1cell + data[8] * 75;
        } else {
            bar1nextCell = prev_width[twoDots[1] + 1] * 75 + padding;
        }

        bar1y = bar1nextCell - (bar1nextCell - bar1cell) / 2;

        // Draw dots
        svg.append('circle')
            .attr("cx", barx - 10)
            .attr("cy", bar0y)
            .attr("r", 5)
            .style("fill", "black");
        svg.append('circle')
            .attr("cx", barx - 10)
            .attr("cy", bar1y)
            .attr("r", 5)
            .style("fill", "black");

        console.log("Dot 0 index: " + twoDots[0]);


        var smallerStack = Math.min(data[twoDots[0]], data[twoDots[1]]);

        var largerStack = Math.max(data[twoDots[0]], data[twoDots[1]]);

        smallerStack = Math.round(smallerStack * 100000) / 100000;
        largerStack = Math.round(largerStack * 100000) / 100000;

        var ratio = Math.round((smallerStack / largerStack) * 100000) / 100000;

        tempData = ["Stacked", smallerStack, largerStack, ratio];

    }


</script>
</body>
</html>
