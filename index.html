<!DOCTYPE html>
<html>
<head>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <title>03-Experiment-JasonDykstra-ColbyFrechette.html</title>
</head>
<body>
<script>
    console.log(d3); // test if d3 is loaded

    //window.onload=drawBarChart();
    window.onload = startPage();

    const csvRows = [["Type", "Smaller", "Larger", "Actual Ratio", "Guess Ratio"]];

    var tempData;

    var numSubmits = 0;
    var maxSubmits = 3;

    // SVG dimensions
    var SVGWidth = 405;
    var SVGHeight = 600;
    //var margins = window.innerWidth/10;
    var margins = 50;

    var svgdiv = document.createElement("div");
    svgdiv.classList.add("svgdiv");
    document.body.appendChild(svgdiv);
    svgdiv.id = "svgdiv";
    var svg = d3.select("#svgdiv")
        .append("svg")
        .attr("width", SVGWidth)
        .attr("height", SVGHeight);

    function startPage() {

        var startbuttonDiv = document.createElement("div");
        var pDiv = document.createElement("div");
        var startDiv = document.createElement("div");


        startbuttonDiv.style.height = "200px";
        pDiv.style.height = "100px";
        //startDiv.style.height = "200px";
        startDiv.id = "startDiv";
        pDiv.id = "pDiv";
        startbuttonDiv.id = "startbuttonDiv";
        startDiv.appendChild(pDiv);
        startDiv.appendChild(startbuttonDiv);
        document.body.appendChild(startDiv);

        var intro = document.createElement("P");
        intro.innerHTML = "In this experiment,<br> you are asked to judge<br> what is the percent of a smaller value to a larger value in several charts. <br> <br> We won't record any other information from you except your answers. <br> Click the \"agree\" button to begin";
        pDiv.appendChild(intro);


        var start = document.createElement("BUTTON");
        var startText = document.createTextNode("Start");
        start.appendChild(startText);
        startbuttonDiv.appendChild(start);
        start.classList.add('StartButton')
        start.classList.add('StartPage')
        start.onclick = function () {
            startDiv.style.display = "none";
            //drawBarChart();
            drawStackedChart();
        }

    }

    function resultsPage(csvContent) {
        var encodedUri = encodeURI(csvContent);
        window.open(encodedUri);
    }

    function textBoxSubmit() {
        var div = document.createElement("div");

        div.style.height = "100px";

        document.body.appendChild(div);

        // Text box
        var textInput = document.createElement("INPUT");
        textInput.setAttribute("placeholder", "Enter Percent E.g. 50");
        textInput.setAttribute("type", "text");
        div.appendChild(textInput);
        var percentIcon = document.createElement("Percent");
        var percentIconText = document.createTextNode("%");
        percentIcon.id = "percentIcon";
        percentIcon.style.fontFamily = "arial";
        percentIcon.appendChild(percentIconText);
        div.appendChild(percentIcon);

        // Submit button
        var submit = document.createElement("Button");
        var submitText = document.createTextNode("Submit");

        submit.appendChild(submitText);
        div.appendChild(submit);
        submit.onclick = function () {
            if (textInput.value < 100) {
                numSubmits++;
                var text = textInput.value;
                console.log(text);
                //userInput = text;

                // Update the csv
                tempData.push(text);
                csvRows.push(tempData);
                let csvContent = "data:text/csv;charset=utf-8,";
                csvRows.forEach(function (rowArray) {
                    let row = rowArray.join(",");
                    csvContent += row + "\r\n";
                });

                console.log(csvRows);
                if (numSubmits < maxSubmits) drawPieChart();
                else resultsPage(csvContent);
            }else{
                alert("Please type a number less than 100")
            }

        }
    }

    //  function resultsPage

    function drawBarChart() {

        // Clear svg

        // Draw the text box for the user to submit data
        textBoxSubmit();



        var barWidth = 50;
        var barPadding = 5;

        // Random Dataset Method 2 (JavaScript Random Number Generation)
        var data2 = [];
        var numDataPoints = 0;
        var maxDataPoints = 8;
        while (numDataPoints < maxDataPoints) {
            var newNumber = Math.random();
            if (newNumber > 0.1) {
                data2.push(newNumber);
                numDataPoints++;
            }
        }

        var twoDots = [];
        while (twoDots.length < 2) {
            var dotIndex = Math.floor(Math.random() * maxDataPoints);
            if (twoDots.length == 1 && twoDots[0] != dotIndex) {
                twoDots[1] = dotIndex;
            } else if (twoDots.length == 0) {
                twoDots[0] = dotIndex;
            }
        }

        console.log("Two dots: " + twoDots);

        console.log(data2);



        // Bar Chart
        svg.selectAll("bar")
            .data(data2)
            .enter()
            .append("rect")
            .attr('class', 'bar')
            .style('height', function (d) {
                return d * 500 + 'px';
            })
            .style('width', barWidth - barPadding)
            .attr("y", function (d) {
                return SVGHeight - d * 500 - barPadding;
            })

            .attr("transform", function (d, i) {
                var translate = [barPadding + barWidth * i, 0];
                return "translate(" + translate + ")";
            })
            .style("stroke", "black")
            .style("stroke-width", 3)
            .style("fill", "none")
        ;

        svg.append('circle')
            .attr("cx", (twoDots[0] * (barWidth)) + barWidth / 2 + barPadding / 2)
            .attr("cy", SVGHeight - 15)
            .attr("r", 10)
            .style("fill", "black");
        svg.append('circle')
            .attr("cx", (twoDots[1] * (barWidth)) + barWidth / 2 + barPadding / 2)
            .attr("cy", SVGHeight - 15)
            .attr("r", 10)
            .style("fill", "black");

        var smallerBarHeight = Math.min(data2[twoDots[0]], data2[twoDots[1]]);

        var largerBarHeight = Math.max(data2[twoDots[0]], data2[twoDots[1]]);

        // Shrink bar heights to 4 decimal places
        smallerBarHeight = Math.round(smallerBarHeight * 100000) / 100000;
        largerBarHeight = Math.round(largerBarHeight * 100000) / 100000;

        var ratio = Math.round((smallerBarHeight / largerBarHeight) * 100000) / 100000;

        console.log("Large dot: " + largerBarHeight);
        console.log("Smaller dot: " + smallerBarHeight);
        console.log("Ratio: " + ratio);


        tempData = ["Bar", smallerBarHeight, largerBarHeight, ratio];


    }

    function drawPieChart(){

        d3.selectAll("svg > *").remove();


        // Random Dataset Method 2 (JavaScript Random Number Generation)
        var data = [];
        var numDataPoints = 0;
        var maxDataPoints = 9;
        while (numDataPoints < maxDataPoints) {
            var newNumber = Math.random();
            if (newNumber > 0.1) {
                data.push(newNumber);
                numDataPoints++;
            }
        }

        var width = 360;
        var height = 360;
        var radius = Math.min(width, height) / 3;

        var color = d3.scaleOrdinal(d3.schemeCategory20b);

        // svg = d3.select('#svgdiv')
        //     .append('svg')
        //     .attr('width', width)
        //     .attr('height', height)
        //     .append('g')
        //     .attr('transform', 'translate(' + ((SVGWidth / 2)) +
        //         ',' + (SVGHeight / 2) + ')');

        //svg.attr('transform', 'translate(' + (width/2) + ',' + (height/2) + ')');

        //Working
        // var arc = d3.arc()
        //     .innerRadius(0)
        //     .outerRadius(radius);
        //
        // var labels = d3.arc()
        //     .outerRadius(radius)
        //     .innerRadius(radius - 20);
        //
        // var pie = d3.pie()
        //     .value(function(d) { return d; })
        //     .sort(null);
        //
        // var path = svg.selectAll('path')
        //     .data(pie(data))
        //     .enter()
        //     .append('path')
        //     .attr('d', arc)
        //     .attr("transform", "translate(" + SVGWidth / 2 + "," + SVGHeight / 2 + ")")
        //     .attr('fill', "white")
        //     .style("stroke","black")
        //     .style("stroke-width",3);

        var pie = d3.pie()
            .value(function(d) {return d.value; })
            .sort(null);
        var data_ready = pie(d3.entries(data));

        console.log(data_ready);

        var arcGenerator = d3.arc()
            .innerRadius(0)
            .outerRadius(radius)

        svg
            .selectAll('pie')
            .data(data_ready)
            .enter()
            .append('path')
            .attr('d', arcGenerator
            )
            .attr("transform", "translate(" + SVGWidth / 2 + "," + SVGHeight / 2 + ")")
            .attr('fill', 'white')
            .attr("stroke", "black")
            .style("stroke-width", "2px")
            .style("opacity", 0.7)




        var twoDots = [];
        while (twoDots.length < 2) {
            var dotIndex = Math.floor(Math.random() * maxDataPoints);
            if (twoDots.length == 1 && twoDots[0] != dotIndex) {
                twoDots[1] = dotIndex;
            } else if (twoDots.length == 0) {
                twoDots[0] = dotIndex;
            }
        }

        /*
        x = cx + r * cos(a)
        y = cy + r * sin(a)
        */

        // Add pi/2 to the angles since a unit circle starts at East while the pie chart start drawing at North
        var dot0startAngle = data_ready[twoDots[0]].startAngle + Math.PI/2;
        var dot0endAngle = data_ready[twoDots[0]].endAngle + Math.PI/2;
        var dot1startAngle = data_ready[twoDots[1]].startAngle + Math.PI/2;
        var dot1endAngle = data_ready[twoDots[1]].endAngle + Math.PI/2;

        var dot0x = -((radius + 20) * (Math.cos(dot0endAngle - (dot0endAngle - dot0startAngle)/2)));
        var dot0y = -((radius + 20) * (Math.sin(dot0endAngle - (dot0endAngle - dot0startAngle)/2)));
        var dot1x = -((radius + 20) * (Math.cos(dot1endAngle - (dot1endAngle - dot1startAngle)/2)));
        var dot1y = -((radius + 20) * (Math.sin(dot1endAngle - (dot1endAngle - dot1startAngle)/2)));

        console.log("cos: " + Math.cos(dot0endAngle));
        console.log("sin: " + Math.sin(dot0endAngle));

        // ADD circles to pie slices
        svg.append("circle")
            .attr("r", 5)
            .attr("cx", dot0x)
            .attr("cy", dot0y)
            .attr("transform", "translate(" + SVGWidth / 2 + "," + SVGHeight / 2 + ")")
            .attr('fill', 'black')
            .attr("stroke", "black")
            .style("stroke-width", "2px");

        svg.append("circle")
            .attr("r", 5)
            .attr("cx", dot1x)
            .attr("cy", dot1y)
            .attr("transform", "translate(" + SVGWidth / 2 + "," + SVGHeight / 2 + ")")
            .attr('fill', 'black')
            .attr("stroke", "black")
            .style("stroke-width", "2px");


        // var smallerWedge = Math.min(data[twoDots[0]], data[twoDots[1]]);
        // var largerWedge = Math.max(data[twoDots[0]], data[twoDots[1]]);
        //
        // var data_ready = pie(d3.entries(arc));


    }

    function drawStackedChart(){
        d3.selectAll("svg > *").remove();

        var data2 = [];
        var numDataPoints = 0;
        var maxDataPoints = 9;
        while (numDataPoints < maxDataPoints) {
            var newNumber = Math.random();
            if (newNumber > 0.1) {
                data2.push(newNumber);
                numDataPoints++;
            }
        }

        var prev_width = [0,
            data2[0],
            data2[0] +  data2[1],
            data2[0] +  data2[1] +  data2[2],
            data2[0] +  data2[1] +  data2[2] + data2[3],
            data2[0] +  data2[1] +  data2[2] + data2[3] + data2[4],
            data2[0] +  data2[1] +  data2[2] + data2[3] + data2[4] + data2[5],
            data2[0] +  data2[1] +  data2[2] + data2[3] + data2[4] + data2[5] + data2[6],
            data2[0] +  data2[1] +  data2[2] + data2[3] + data2[4] + data2[5] + data2[6] + data2[7]
        ];

        var barWidth = 60;
        var padding = 5;

        svg.selectAll('rect')
            .data(data2)
            .enter()
            .append('rect')
            .attr('width', barWidth)
            .attr('x',SVGWidth/2 - barWidth/2)
            .attr('fill','white')
            .style('stroke','black')
            .style('stroke-width',3)
            .attr('y',function(d, i){
                return prev_width[i] * 100 + padding; })
            .attr('height', function(d){
                return d*100;
        });

    }


</script>
</body>
</html>
